<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tables</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            background-color: #f0f0f0;
            color: #000000;
            font-family: Arial, sans-serif;
        }
        .content {
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }
        h1 {
            color: #000000;
            text-align: left;
        }
        select, button, input[type="date"] {
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #cccccc;
            padding: 5px 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        select:focus, button:hover, input[type="date"]:focus {
            border-color: #007bff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
        }
        th, td {
            border: 1px solid #dddddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #add-record-btn {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        #add-record-btn:hover {
            background-color: #0056b3;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-links">
            <li><a href="{{ url_for('routes.index') }}">Home</a></li>
            <li><a href="{{ url_for('view_routes.view_data') }}">Products Milled</a></li>
            <li><a href="{{ url_for('view_routes_transfers.view_data_transfers') }}">Transfers-Conditioning</a></li>
            <li><a href="{{ url_for('view_routes_water.view_data_water') }}">Water Stage</a></li>
            <li><a href="{{ url_for('dash_bp.render_dash') }}">Dash Page</a></li>
            <li><a href="{{ url_for('manage_tables_bp.manage_tables') }}">Manage Tables</a></li>
        </ul>
    </nav>
    <div class="content">
        <h1>Manage Tables</h1>
        <select id="table-select">
            <option value="Mill">Mill</option>
            <option value="Miller">Miller</option>
            <option value="Transfer_Type">Transfer Type</option>
            <option value="Water_Conditioning">Water Conditioning</option>
            <option value="Water_Stage">Water Stage</option>
            <option value="Product_Table">Product</option>
            <option value="Product_Movement_Log">Product Movement Log</option>
            <option value="Transfer_Movement_Log">Transfer Movement Log</option>
            <option value="Stage_Movement_Log">Stage Movement Log</option>
        </select>
        <table id="records-table">
            <thead id="records-header">
                <!-- Table header will be dynamically populated -->
            </thead>
            <tbody id="records-body">
                <!-- Records will be displayed here -->
            </tbody>
        </table>
        <button id="add-record-btn">Add New Record</button>
    </div>

    <!-- Correction Modal -->
    <div id="correctionModal" class="modal">
        <div class="modal-content">
            <h2>Correct Entry</h2>
            <p id="correctionDetails"></p>
            <input type="number" id="newEndValue" placeholder="New End Value">
            <button onclick="submitCorrection()">Submit Correction</button>
            <button onclick="closeCorrectionModal()">Cancel</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/manage_tables.js') }}"></script>
    <script>
        let currentCorrectionData = null;
        const movementLogTables = ['Product_Movement_Log', 'Transfer_Movement_Log', 'Stage_Movement_Log'];

        document.getElementById('table-select').addEventListener('change', function() {
            const tableName = this.value;
            fetchTableData(tableName);
            toggleAddRecordButton(tableName);
        });

        function toggleAddRecordButton(tableName) {
            const addRecordBtn = document.getElementById('add-record-btn');
            if (movementLogTables.includes(tableName)) {
                addRecordBtn.style.display = 'none';
            } else {
                addRecordBtn.style.display = 'block';
            }
        }

        function fetchTableData(tableName) {
            fetch(`/api/${tableName}`)
                .then(response => response.json())
                .then(data => {
                    const headerRow = document.getElementById('records-header');
                    const tbody = document.getElementById('records-body');
                    headerRow.innerHTML = '';
                    tbody.innerHTML = '';

                    if (movementLogTables.includes(tableName)) {
                        headerRow.innerHTML = `
                            <tr>
                                <th>Date</th>
                                <th>Mill</th>
                                <th>Shift</th>
                                <th>Miller</th>
                                <th>Product/Transfer/Stage</th>
                                <th>Opening Balance</th>
                                <th>Closing Balance</th>
                                <th>Movement</th>
                                <th>Action</th>
                            </tr>
                        `;
                        data.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.date}</td>
                                <td>${record.mill_name}</td>
                                <td>${record.shift}</td>
                                <td>${record.miller}</td>
                                <td>${record.name}</td>
                                <td>${record.opening_balance}</td>
                                <td>${record.closing_balance}</td>
                                <td>${record.movement}</td>
                                <td><button onclick="openCorrectionModal('${tableName}', ${record.log_id}, '${record.id_field}', ${record.id}, ${record.mill_id}, '${record.date}', '${record.mill_name}', '${record.name}', ${record.opening_balance}, ${record.closing_balance})">Correct</button></td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        headerRow.innerHTML = `
                            <tr>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        `;
                        data.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.name}</td>
                                <td>
                                    <button onclick="editRecord(${record.id})">Edit</button>
                                    <button onclick="deleteRecord(${record.id})">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
        }

        function openCorrectionModal(tableName, logId, idField, idValue, millId, date, millName, productName, openingBalance, closingBalance) {
            currentCorrectionData = { tableName, logId, idField, idValue, millId };
            document.getElementById('correctionDetails').innerHTML = `
                Date: ${date}<br>
                Mill: ${millName}<br>
                Product: ${productName}<br>
                Opening Balance: ${openingBalance}<br>
                Current Closing Balance: ${closingBalance}
            `;
            document.getElementById('correctionModal').style.display = 'block';
        }

        function closeCorrectionModal() {
            document.getElementById('correctionModal').style.display = 'none';
            currentCorrectionData = null;
        }

        function submitCorrection() {
            const newEndValue = document.getElementById('newEndValue').value;
            if (newEndValue && currentCorrectionData) {
                fetch('/api/correct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        table_name: currentCorrectionData.tableName,
                        log_id: currentCorrectionData.logId,
                        id_field: currentCorrectionData.idField,
                        id_value: currentCorrectionData.idValue,
                        new_end_value: parseFloat(newEndValue),
                        mill_id: currentCorrectionData.millId
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Correction applied successfully');
                        closeCorrectionModal();
                        fetchTableData(currentCorrectionData.tableName);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('An error occurred while applying the correction');
                });
            }
        }

        // Initial load
        const initialTableName = document.getElementById('table-select').value;
        fetchTableData(initialTableName);
        toggleAddRecordButton(initialTableName);
    </script>
</body>
</html>
